<template id="tx-table">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .tx-table {
            display: table;
        }
        tx-row {
            display: contents;
        }
        .pagination-container {
            text-align: center;
            width: 100%;
        }
        .pagination-next, .pagination-back {
            cursor: pointer;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

        .pagination-idx {
            min-width: 50px;
            max-width: 50px;
            width: 50px;
            margin: 7px 7px 7px 3px;
            text-align: center;
            height: 35px;
        }
        .search {
            /* float: right; */
            margin: auto;
            width: 100%;
            max-width: 350px;
        }
        .search-container {
            width: 100%;
            display: flex;
            margin-bottom: 0.5em;
        }
        .up-arrow {
            width: 0;
            height: 0;
            border: solid 5px transparent;
            background: transparent;
            border-bottom: solid 7px #fff;
            border-top-width: 0;
            cursor: pointer;
            float: right;
            margin-right: 50px;
            margin-top: 5px;
        }

        .down-arrow {
            width: 0;
            height: 0;
            border: solid 5px transparent;
            background: transparent;
            border-top: solid 7px #fff;
            border-bottom-width: 0;
            margin-top:1px;
            cursor: pointer;
            float: right;
            margin-right: 50px;
            margin-top: 5px;
        }
        
        .export-container {
            max-width: 50%;
            margin: 20px auto;
            border: 1px solid #fff;
            padding: 20px;
            text-align: center;
            border-radius: 7px;
        }
        .export {
            max-width: 200px;
            margin: auto;
        }
        .selected-rows-action-box {
            float: right;
        }
        .selected-rows-action-box .btn {
            width: 200px;
            margin: 5px;
            height: 38px;
        }
    </style>
    <nav class="switcher row">
        <button
            type="button"
            class="txlist-view-btn btn radio left">
            {{ _("History") }}
        </button>
        <button
            type="button"
            class="utxo-view-btn btn radio right">
            UTXO
        </button>
    </nav>
    <div class="pagination-container">
        <a class="pagination-back pagination-arrow pagination-disabled">&#8249;</a>
        {{ _("Page") }} <input class="pagination-idx" type="number" step="1" min="1" value="1"></input><span class="pagination-counter"></span>
        <a class="pagination-next pagination-arrow pagination-disabled">&#8250;</a>
        <br>
    </div>
    <div class="search-container">
        <!--Left part of the toolbar-->
        <div style="flex: 1;">
            {% include "includes/page-limit-select.html" %}
        </div>
        <!--Middle part of the toolbar-->
        <input class="search" type="text" placeholder="Search..." />
        <tool-tip title="Search options">
            {{ _("anything in the address, tx, label, confirmations or amount") }}<br>
            {{ _('search like') }} <code>%d.%m.%Y %H:%M</code> {{ _('if you want to search in the time field') }}<br>
            {{ _("<code> 1</code> for anything more than 1 BTC and likewise <code>< 1</code> (don't forget the space)") }}<br>
        </tool-tip>
        <!--Placeholder for right part of the toolbar-->
        <div style="flex: 1;"></div>
    </div>
    <div class="selected-rows-action-box row hidden">
        <form class="freeze-tx-form" method="POST">
            <input type="hidden" class="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="button" class="btn freeze-tx-btn">
                <tool-tip title="Freezing UTXOs">
                    {{ _("Freezing a UTXO will make Specter disallow spending it.") }}<br><br>
                    {{ _("This is useful especially for dealing with a dust attack, where you don't want to accidentally spend the dust received.") }}"
                </tool-tip>&nbsp;&nbsp;
                Un/Freeze UTXOs
            </button>
        </form>
        <form class="compose-tx-form" method="POST">
            <input type="hidden" class="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="button" class="btn compose-tx-btn">{{ _("Create new transaction") }}</button>
        </form>
    </div>
    <div class="export-container hidden">
        <h1>{{ _("Export transactions to CSV") }}</h1>
        <div class="{% if not specter.price_check or not (specter.alt_rate and specter.alt_symbol) %}hidden{% endif %}">
        {{ _("Fetch historical price data") }}:
        <label class="switch">
        <input type="checkbox" class="export-prices">
        <span class="slider"></span>
        </label><br><br>
        <div class="note">
            {{ _("If enabled, specter will try to fetch historical prices for each transaction date from the configured price provider.") }}
            <br><b>{{ _("This has privacy implications!") }}</b>
        </div><br>
        </div>
        <a class="export btn" download>{{ _("Export") }}</a>
    </div>
    <table class="tx-table">
        <thead>
            <tr>
                <th value="callbackaction" class="column-callbackaction customaction-header"></th>
                <th value="category" class="column-category category-header"><div class="category-arrow"></div></th>
                <th value="txid"     class="column-txid optional txid-header">TxID<div class="txid-arrow"></div></th>
                <th value="label"    class="column-label optional label-header">{{ _("Label") }}<div class="label-arrow"></div></th>
                <th value="amount"   class="column-amount amount-header">{{ _("Amount") }}<div class="amount-arrow"></div></th>
                <th value="time"     class="column-time time-header">{{ _("Time") }}<div class="time-arrow up-arrow"></div></th>
                <th value="confirmations" class="column-confirmations confirmations-header">{{ _("Confirmations") }}<div class="confirmations-arrow"></div></th>
                <th value="blockhash" class="column-blockhash optional hidden blockhash-header">
                    {{ _("Block Hash") }}
                    {% include "includes/merkletooltip.html" %}
                </th>
                <th class="column-action" style="width: 50px; padding: 10px;">
                    <button type="button" class="export-btn btn" style="width: 50px;">
                        {{ _("Export") }}
                    </button>
                </th>
            </tr>
        </thead>
    <tr class="empty">
        <td class="column-callbackaction"></td>
        <td class="column-category"></td>
        <td class="column-txid">{{ _("Fetching transactions...") }}</td>
        <td class="column-label optional"></td>
        <td class="column-amount optional"></td>
        <td class="column-time" ></td>
        <td class="column-confirmations"></td>
        <td class="column-blockhash optional hidden blockhash-empty"></td>
        <td class="column-action"></td>
    </tr>
    <tr class="summary-row hidden">
        <td class="column-callbackaction"></td>
        <td class="column-category" ></td>
        <td class="column-txid summary-tx-count"></td>
        <td class="column-label optional"></td>
        <td class="column-amount summary-amount"></td>
        <td class="column-time optional"></td>
        <td class="column-confirmations"> </td>
        <td class="column-blockhash optional hidden blockhash-summary"></td>
        <td class="column-action"></td>
    </tr>
	<tbody class="tx-tbody">
	</tbody>
    </table>
</template>

<script type="text/javascript">
    /**
     * Custom element for showing a table of transactions.
     * Can be configured to show:
     *  - The transaction history of a wallet (set attribute `type` to "txlist" and `wallet` to the wallet's alias)
     *  - The UTXO list of a wallet (set attribute `type` to "utxo" and `wallet` to the wallet's alias)
     *  - The transaction history of all the user's wallets (set attribute `type` to "txlist" and `wallet` to null)
     *  - The UTXO list of all the user's wallets (set attribute `type` to "utxo" and `wallet` to null)
     * The uses Specter's API to fetch transactions every time the user changes its parameters.
     * These parameters are configured using components included in this table element:
     *  - Tabs for switching between History (`type="txlist"`) and UTXO (`type="utxo"`) list types
     *  - Sorting transactions by any column (ascending or descending)
     *  - Search bar to filter transactions using free text search
     *  - Configuring limit for transactions displayed per page
     *  - Pagination, jumping between pages and showing the total pages count
     *  - Export - export the full (unfiltered) list from which the table is drawing its data as CSV (optionally with price history)
     * 
     * The table also supports:
     *  - Showing amounts in either BTC or sats (set attribute `btc-unit` to either "btc" or "sat")
     *  - Showing prices next to the amounts (set attribute `price` to the BTC price and symbol to the symbol of the currency you're pricing at)
     *  - Showing validated blockhash column (set attribute `blockhash` to either "true" or "false")
     *  - Limiting txs/utxos to just those associated with the specified `data-service-id`.
     *  - Hide columns by hide-columns="category time"
    */
    class TxTableElement extends HTMLElement {
        constructor() {
            super();
            // Create a shadow root
            var shadow = this.attachShadow({mode: 'open'});
            var style = document.getElementById('tx-table').content;
            var clone = style.cloneNode(true);
            this.el = clone.querySelector(".tx-table");
            this.tbody = clone.querySelector(".tx-tbody");

            // Empty row element
            this.emptyRow = clone.querySelector(".empty");

            // Blockhash header and empty column
            this.blockhashHeader = clone.querySelector(".blockhash-header");
            this.blockhashEmpty = clone.querySelector(".blockhash-empty");
            this.blockhashSummary = clone.querySelector(".blockhash-summary");

            // Tabs (History/ UTXO)
            this.txlistViewBtn = clone.querySelector(".txlist-view-btn");
            this.utxoViewBtn = clone.querySelector(".utxo-view-btn");

            // Pagination
            this.paginationNext = clone.querySelector(".pagination-next");
            this.paginationBack = clone.querySelector(".pagination-back");
            this.paginationContainer = clone.querySelector(".pagination-container");
            this.paginationCounter = clone.querySelector(".pagination-counter");
            this.paginationIdxInput = clone.querySelector(".pagination-idx");
            this.pageLimitSelect = clone.querySelector(".page-limit-select");

            // Search bar element
            this.searchInput = clone.querySelector(".search");

            // Sorting headers and arrows
            this.categoryHeader = clone.querySelector(".category-header");
            this.txidHeader = clone.querySelector(".txid-header");
            this.labelHeader = clone.querySelector(".label-header");
            this.amountHeader = clone.querySelector(".amount-header");
            this.timeHeader = clone.querySelector(".time-header");
            this.confirmationsHeader = clone.querySelector(".confirmations-header");
            this.categoryArrow = clone.querySelector(".category-arrow");
            this.txidArrow = clone.querySelector(".txid-arrow");
            this.labelArrow = clone.querySelector(".label-arrow");
            this.amountArrow = clone.querySelector(".amount-arrow");
            this.timeArrow = clone.querySelector(".time-arrow");
            this.confirmationsArrow = clone.querySelector(".confirmations-arrow");

            // Summary row
            this.summaryRow = clone.querySelector(".summary-row");
            this.summaryTxCount = clone.querySelector(".summary-tx-count");
            this.summaryAmount = clone.querySelector(".summary-amount");

            // Export button
            this.exportBtn = clone.querySelector(".export-btn");
            this.exportContainer = clone.querySelector(".export-container");
            this.export = clone.querySelector(".export");
            this.exportPricesSwitch = clone.querySelector(".export-prices");

            // Selected rows
            this.selectedRowsActionBox = clone.querySelector(".selected-rows-action-box");
            this.composeTxForm = clone.querySelector(".compose-tx-form");
            this.composeTxBtn = clone.querySelector(".compose-tx-btn");
            this.freezeTxForm = clone.querySelector(".freeze-tx-form");
            this.freezeTxBtn = clone.querySelector(".freeze-tx-btn");
            this.selectedRows = [];

            // CustomAction Preselection default
            this.selectedCoins = []
            
			this.txlistViewBtn.onclick = () => {
				if (!this.txlistViewBtn.classList.contains("checked")) {
					this.utxoViewBtn.classList.remove("checked");
					this.txlistViewBtn.classList.add("checked");
					this.setAttribute("type","txlist");
				}
			}

			this.utxoViewBtn.onclick = () => {
				if (!this.utxoViewBtn.classList.contains("checked")) {
					this.txlistViewBtn.classList.remove("checked");
					this.utxoViewBtn.classList.add("checked");
					this.setAttribute("type","utxo");
				}
            }
            
            // Init call id to avoid fetch returning after another one triggered
            this.callId = 0


            // Initialize default sort, search, limit and page parameters
            this.idx = 0;
            this.limit = 50;
            this.search = "";
            this.sortby = "time";
            this.sortdir = "desc";
            this.pageCount = 1;
            
            // Next page action
            this.paginationNext.onclick = () => {
                this.idx++;
                console.log("paginationNext fetch");
                
            }

            // Previous page action
            this.paginationBack.onclick = () => {
                this.idx--;
                console.log("paginationBack fetch");
                this.update();
            }

            // Listen to changes in page number selection input
            this.paginationIdxInput.onchange = () => {
                let newIdx = parseInt(this.paginationIdxInput.value);
                if (isNaN(newIdx) || (newIdx < 1 || newIdx > this.pageCount)) {
                    this.paginationIdxInput.value = this.idx + 1;
                    return;
                }
                this.idx = newIdx - 1;
                console.log("paginationIdxInput fetch");
                this.update();
            }

            // Listen to changes in search bar
            this.searchInput.onchange = () => {
                this.search = this.searchInput.value;
                this.export.href = this.export.href.split('?')[0] + `?exportPrices=${this.exportPricesSwitch.checked}&search=${this.search}&sortby=${this.sortby}&sortdir=${this.sortdir}`;
                console.log("searchInput fetch");
                this.update();
            }

            // Listen to changes in page limit
            this.pageLimitSelect.onchange = () => {
                this.limit = this.pageLimitSelect.value;
                console.log("pageLimitSelect fetch");
                this.update();
            }

            // Setup sorting functionality for each column of the table header
            let sortHeaders = [
                this.categoryHeader,
                this.txidHeader,
                this.labelHeader,
                this.amountHeader,
                this.timeHeader,
                this.confirmationsHeader
            ];

            for (let header of sortHeaders) {
                header.onclick = () => {
                    if (header.classList.toString().indexOf(this.sortby) != -1) {
                        // flip direction
                        this.el.querySelector(`.${this.sortby}-arrow`).classList.remove(this.sortdir == 'asc' ? 'down-arrow' : 'up-arrow');
                        this.el.querySelector(`.${this.sortby}-arrow`).classList.add(this.sortdir == 'asc' ? 'up-arrow' : 'down-arrow');
                        this.sortdir = this.sortdir == 'asc' ? 'desc' : 'asc';
                        this.export.href = this.export.href.split('?')[0] + `?exportPrices=${this.exportPricesSwitch.checked}&search=${this.search}&sortby=${this.sortby}&sortdir=${this.sortdir}`;
                    } else {
                        sortHeaders.forEach(el => {
                            let existingArrow = el.querySelector(`.${this.sortby}-arrow`)
                            if (existingArrow) {
                                existingArrow.classList.remove('up-arrow');
                                existingArrow.classList.remove('down-arrow');
                            }
                        });
                        this.sortby = header.getAttribute('value');
                        this.el.querySelector(`.${this.sortby}-arrow`).classList.add(this.sortdir == 'asc' ? 'down-arrow' : 'up-arrow');
                        this.export.href = this.export.href.split('?')[0] + `?exportPrices=${this.exportPricesSwitch.checked}&search=${this.search}&sortby=${this.sortby}&sortdir=${this.sortdir}`;
                    }
                    console.log("header fetch")
                }
            }

            // Export data
            this.exportBtn.onclick = () => {
                if (this.exportBtn.innerText == 'Done') {
                    this.exportContainer.classList.add('hidden');
                    this.exportBtn.innerText = 'Export';
                } else {
                    this.exportContainer.classList.remove('hidden');
                    this.exportBtn.innerText = 'Done';
                }
            }

            this.export.onclick = () => {
                this.exportContainer.classList.add('hidden');
                this.exportBtn.innerText = 'Export';
            }
            
            // Export prices switch toggle
            this.exportPricesSwitch.onchange = () => {
                this.export.href = this.export.href.split('?')[0] + `?exportPrices=${this.exportPricesSwitch.checked}&search=${this.search}&sortby=${this.sortby}&sortdir=${this.sortdir}`;
            }

            this.composeTxBtn.onclick = () => {
                for (let tx of this.selectedRows) {
                    this.composeTxForm.innerHTML += `
                        <input type="checkbox" checked class="hidden" name="coinselect" value="${tx.txid}, ${tx.vout}">
                    `
                }
                this.composeTxForm.action = `{{ url_for('wallets_endpoint.send_new', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
                this.composeTxForm.submit();
            }

            this.freezeTxBtn.onclick = () => {
                for (let tx of this.selectedRows) {
                    this.freezeTxForm.innerHTML += `
                        <input type="checkbox" checked class="hidden" name="selected_utxo" value="${tx.txid}:${tx.vout}">
                    `
                }
                this.freezeTxForm.innerHTML += `<input type="hidden" name="action" value="freezeutxo"/>`
                this.freezeTxForm.action = `{{ url_for('wallets_endpoint.history', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
                this.freezeTxForm.submit();
            }

            // Attach the created element to the shadow dom
            shadow.appendChild(clone);
        }

        static get observedAttributes() {
            return ['blockhash', 'btc-unit', 'price', 'symbol', 'type', 'hide-sensitive-info', 'wallet', 'service-id', 'selected-coins'];
        }

        connectedCallback() {
            // Hide columns
            this.hideColumns = this.getAttribute("hide-columns") ?? "callbackaction"
            if (this.hideColumns && this.hideColumns != "null") {
                this.hideColumns.split(" ").forEach((column_name) => {
                    if (column_name !== null) {
                        this.shadowRoot.querySelectorAll(".column-"+ column_name).forEach((element) => {
                            element.remove()
                        })
                    }
                })
            }
            // Hide the switcher
            this.hideSwitcher = this.getAttribute("hide-switcher")
            if (this.hideSwitcher && this.hideSwitcher.toLowerCase() == "true") {
                this.shadowRoot.querySelector(".switcher").classList.add('hidden')
            }
            this.update();
        }

        getSelectedTxs() {
            var selectedTxs = []
            this.shadowRoot.querySelectorAll(".txrowitem").forEach((item) => {
                if (item.isSelected()) {
                    selectedTxs.push(item.tx)
                }
            })
            return selectedTxs
        }

        unselect_all() {
            this.shadowRoot.querySelectorAll(".txrowitem").forEach((item) => {
                item.unselect()
            })
        }

        select_coins(selected_coins) {
            this.shadowRoot.querySelectorAll(".txrowitem").forEach((item) => {
                selected_coins.forEach((selected_coin) => {
                    selected_coin.split(/,/)
                    if (item.isSelected()) {

                    }
                })
            })
        }

        /**
         * 
         * Listens to changes on the following attributes:
         * - blockhash: Should show blockhash column. Either "true" or "false"
         * - btc-unit: Bitcoin unit to display amounts with. Either "btc" or "sat"
         * - price: BTC price for price calculations
         * - symbol: Currency symbol for price calculations
         * - type: Transactions list type to load. Either "txlist" or "utxo"
         * - hide-sensitive-info: Mask user sensitive info. Either "true" or "false"
         * - wallet: The wallet alias (null to get all wallets combined)
        */
        attributeChangedCallback(attrName, oldValue, newValue) {
            if (attrName != "selected-coins") {
                if (this.getAttribute('blockhash') == 'true' && this.getAttribute('type') == "txlist" && this.getAttribute('wallet')) {
                        this.blockhashHeader.classList.remove('hidden');
                        this.blockhashEmpty.classList.remove('hidden');
                        this.blockhashSummary.classList.remove('hidden');
                } else {
                    this.blockhashHeader.classList.add('hidden');
                    this.blockhashEmpty.classList.add('hidden');
                    this.blockhashSummary.classList.add('hidden');
                }
                if (
                    this.blockhash != this.getAttribute('blockhash') ||
                    this.btcUnit != this.getAttribute('btc-unit') ||
                    this.price != this.getAttribute('price') ||
                    this.symbol != this.getAttribute('symbol') ||
                    this.listType != this.getAttribute('type') ||
                    this.hideSensitiveInfo != this.getAttribute('hide-sensitive-info') ||
                    this.wallet != this.getAttribute('wallet') ||
                    this.serviceId != this.getAttribute('service-id')
                ) {
                    this.blockhash = this.getAttribute('blockhash');
                    this.btcUnit = this.getAttribute('btc-unit');
                    this.price = this.getAttribute('price');
                    this.symbol = this.getAttribute('symbol');
                    this.listType = this.getAttribute('type');
                    this.hideSensitiveInfo = this.getAttribute('hide-sensitive-info') == 'true';
                    this.wallet = this.getAttribute('wallet');
                    this.serviceId = this.getAttribute('service-id');
                    if (!this.listType) {
                        return
                    }
                    if (oldValue) {
                        this.update();
                    }
                    
                }
            }
            if (attrName == "selected-coins" && newValue != undefined && newValue != "undefined") {
                
                let selectedCoins = JSON.parse(newValue)
                this.selectedCoins = selectedCoins.map((txid_vout) => {
                    // For easier comparison, we're removing the vout
                    let txid = txid_vout.split(/,/)[0]
                    return txid
                })
            }
        }

        /**
         * searches this.selectedCoin for a transactionId and removes that if found and returns True in that case.
         * Explanation: An initial pre-ticking the checkboxes is not that easy as the state of the component is
         * created dynamically. This also involves the preselected checkboxes which get set by setAttribute("selected-coins",...)
         * In order to solve this, this.selectedCoins is an array of txids which nedd to be checked and they get "consumed" when the 
         * the check is positive.
         */
        checkForSelectedCoin(txid) {
           if (this.selectedCoins != []) {
               let filtered = this.selectedCoins.filter((value, index, arr) => {
                   return value != txid
               })
               if (filtered.length == this.selectedCoins.length) {
                   return false
               } else {
                   console.log("Found txid"+txid)
                   this.selectedCoins = filtered
                   return true
               }
           } 
           return false
        }

        update() {
            if (this.getAttribute('tx-data')) {
                // faking a jsonResponse for the render-method
                let jsonResponse = {
                    pageCount: 1,
                    txlist: this.getAttribute('tx-data')
                }
                let showBlockhash = !this.blockhashHeader.classList.contains('hidden');
                this.render(jsonResponse, showBlockhash)
            } else {
                this.fetchTxItems()
            }
        }

        /**
         * Fetches txlist from the Specter API and loads the result into TxRowElements
        */
        async fetchTxItems() {
            this.callId++;
            // Select the correct URL based on the list type and selected wallet
            let url;
            switch (this.listType) {
                case "txlist":
                    if (this.wallet) {
                        this.export.href = `{{ url_for('wallets_endpoint_api.tx_history_csv', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
                        url = `{{ url_for('wallets_endpoint_api.txlist', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
                    } else {
                        this.export.href = `{{ url_for('wallets_endpoint_api.wallet_overview_txs_csv') }}`;
                        url = `{{ url_for('wallets_endpoint_api.wallets_overview_txlist') }}`;
                    }
                    break;
                case "utxo":
                    if (this.wallet) {
                        this.export.href = `{{ url_for('wallets_endpoint_api.utxo_csv', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
                        url = `{{ url_for('wallets_endpoint_api.utxo_list', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
                    } else {
                        this.export.href = `{{ url_for('wallets_endpoint_api.wallet_overview_utxo_csv') }}`;
                        url = `{{ url_for('wallets_endpoint_api.wallets_overview_utxo_list') }}`;
                    }
                    break
                default:
                    this.export.href = ``
                    this.emptyRow.children[1].innerText = '{{ _("Failed to fetch transactions...") }} ';
                    return
            }

            if (this.export.href != '') {
                this.export.href += `?exportPrices=${this.exportPricesSwitch.checked}&search=${this.search}&sortby=${this.sortby}&sortdir=${this.sortdir}`;
            }

            // Prepare form data with all relevant parameters
            var formData = new FormData();
            formData.append('idx', this.idx);
            formData.append('limit', this.limit);
            formData.append('search', this.search);
            formData.append('sortby', this.sortby);
            formData.append('sortdir', this.sortdir);
            if (this.serviceId) {
                formData.append('service_id', this.serviceId);
            }
            formData.append('csrf_token', '{{ csrf_token() }}');
            try {
                let callId = this.callId;
                const response = await fetch(
                    url,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                if (callId != this.callId) {
                    return;
                }
                if(response.status != 200){
                    showError(await response.text());
                    return;
                }
                const jsonResponse = await response.json();
                let showBlockhash = !this.blockhashHeader.classList.contains('hidden');
                
                if ("txlist" in jsonResponse) {
                    this.render(jsonResponse, showBlockhash)
                    return
                };
                showError(`{{ _("Failed to fetch transactions list.") }}`)
            } catch(e) {
                console.log("Caught error: ", e);
                showError(`{{ _("Failed to fetch transactions list.") }}: ${e}`);
            }
        }
        
        render(jsonResponse, showBlockhash) {
            // jsonresponse is something like:
            // {
            //  "pageCount": 1, 
            //  "txlist": "[{\"txid\": \"1f2b4f9b6762ab37d3b0495cda51d8733c68a5e3a01356f0a67f215a29b2f05e\", \"blockhash\": \"05d7c1f7c4fa2a530e0916dcd15551657c22f4c30df175292b0c0b0f320adc10\", \"blockheight\": 722, \"time\": 1644162928, \"conflicts\": [], \"bip125-replaceable\": \"no\", \"vsize\": null, \"category\": \"receive\", \"address\": \"bcrt1qc3z4j7kksr3wm2heaahzx62yjrj8fn83s7x3ps\", \"amount\": 20.0, \"ismine\": true, \"confirmations\": 132, \"label\": \"Address #7\", \"validated_blockhash\": \"\", \"wallet_alias\": \"myhot_2\"}, {\"txid\": \"aafaecb085944a6fce4556885c1f10c1cd97bac146a2a0e676a2b12bcf428d3b\", \"blockhash\": \"201eea173347cdc8e8effeaf96053b5867860cec163f3eacec7c8918c94bdaaa\", \"blockheight\": 721, \"time\": 1644162928, \"conflicts\": [], \"bip125-replaceable\": \"no\", \"vsize\": null, \"category\": \"receive\", \"address\": \"bcrt1qyncynwdxmeynk245wa3f4urul3nm2v0ulfueek\", \"amount\": 20.0, \"ismine\": true, \"confirmations\": 133, \"label\": \"Address #6\", \"validated_blockhash\": \"\", \"wallet_alias\": \"myhot_2\"}, {\"txid\": \"bf34b090996dfcd2971c88f645edd4a0a0ad180e15096389d8841cf2bac0ecde\", \"blockhash\": \"07952e41edea8a9507722531e922b9d217518d6116ba4fba47c9e62ce12dee9e\", \"blockheight\": 305, \"time\": 1644159720, \"conflicts\": [], \"bip125-replaceable\": \"no\", \"vsize\": null, \"category\": \"receive\", \"address\": \"bcrt1qyncynwdxmeynk245wa3f4urul3nm2v0ulfueek\", \"amount\": 20.0, \"ismine\": true, \"confirmations\": 549, \"label\": \"Address #6\", \"validated_blockhash\": \"\", \"wallet_alias\": \"myhot_2\"}]"
            //  }

            // Clean up from existing transaction list
            this.summaryRow.classList.add('hidden');
            this.emptyRow.children[1].innerText = '{{ _("Fetching transactions...") }}';
            this.emptyRow.classList.remove('hidden');
            this.tbody.querySelectorAll('tx-row').forEach((row) => {row.remove()});
            if (!this.listType) {
                this.emptyRow.children[1].innerText = '{{ _("Failed to fetch transactions...") }}';
                return
            }

            if (this.listType == "txlist") {
                this.txlistViewBtn.classList.add("checked");
            } else {
                this.utxoViewBtn.classList.add("checked");
            }

            // Populate the table with TXRowElement objects using the fetched txlist
            if (jsonResponse.txlist) {
                let txlist = JSON.parse(jsonResponse.txlist);
                let summaryTxCount = 0;
                let summaryAmount = 0;
                let summaryPrice = 0;
                for (let tx of txlist) {
                    let txRow = document.createRange().createContextualFragment(`
                    <tx-row class="txrowitem"
                        data-btc-unit="${this.btcUnit ? this.btcUnit : 'btc'}"
                        data-price="${this.price ? this.price : 0}"
                        data-symbol="${this.symbol ? this.symbol : ''}"
                        data-tx='${JSON.stringify(tx).replace(/[\(]/g, "&lpar;").replace(/[\)]/g, "&rpar;").replace(/[\/]/g, "&sol;").replace(/[\']/g, "&apos;")}'
                        data-wallet="${(this.wallet ? this.wallet : tx.wallet_alias)}"
                        data-show-blockhash="${showBlockhash}"
                        data-mode="${this.getAttribute('type') + (this.wallet ? "" : "-overview")}"
                        data-hide-sensitive-info="${this.hideSensitiveInfo}"
                        hide-columns="${this.hideColumns}">
                        </tx-row>
                    `)
                    this.tbody.append(txRow);
                    summaryTxCount++;
                    summaryAmount += parseFloat(this.tbody.children[this.tbody.children.length - 1].shadowRoot.querySelector('.amount').innerText.replace(',', ''));
                    summaryPrice += parseFloat(this.tbody.children[this.tbody.children.length - 1].shadowRoot.querySelector('.amount-price').innerText.replace(`(${this.symbol}`, '').replace(')', '').replace(',', ''));
                }

                if (summaryTxCount > 0 && this.search) {
                    this.summaryTxCount.innerText = `Transactions count: ${summaryTxCount}`;
                    this.summaryAmount.innerHTML = `Total amount: ${numberWithCommas(summaryAmount.toFixed(8))}`;
                    if (summaryPrice) {
                        this.summaryAmount.innerHTML += ` <span class="note">(${this.symbol}${numberWithCommas(summaryPrice.toFixed(2))})</span>`
                    }
                    this.summaryRow.classList.remove('hidden');
                }
                // Pagination
                this.pageCount = jsonResponse.pageCount;
                // Show empty row if no transaction found
                if (this.pageCount == 0 || txlist.length == 0) {
                    this.emptyRow.classList.remove('hidden');
                    this.emptyRow.children[1].innerText = '{{ _("No transactions found...") }}';
                    this.pageCount = 1;
                } else {
                    this.emptyRow.classList.add('hidden');
                }

                // If index is greater than the pages count fetch again for the last page
                if (this.idx >= this.pageCount) {
                    this.idx = this.pageCount - 1;
                    console.log("index greater than pages count fetch");
                    this.fetchTxItems()
                }

                this.paginationIdxInput.value = this.idx + 1;

                // If there are multiple pages show the pagination bar
                if (this.pageCount > 1) {
                    this.paginationContainer.classList.remove('hidden');
                    this.paginationCounter.innerText = `of ${this.pageCount}`;
                    this.paginationIdxInput.max = this.pageCount;
                } else {
                    this.paginationContainer.classList.add('hidden');
                }

                // Disable pagination back button if on the first page
                if (this.idx == 0) {
                    this.paginationBack.classList.add('pagination-disabled');
                } else {
                    this.paginationBack.classList.remove('pagination-disabled');
                }

                // Disable pagination next button if on the last page
                if (this.idx + 1 == this.pageCount) {
                    this.paginationNext.classList.add('pagination-disabled');
                } else {
                    this.paginationNext.classList.remove('pagination-disabled');
                }

                this.selectedRows = [];
                this.selectedRowsActionBox.classList.add('hidden');

                // if preselectedCoins are there, we need to dispatch an event
                let dispatchLater = false
                for (let txRow of this.shadowRoot.querySelectorAll('tx-row')) {
                    // Preselect if necessary
                    if (this.checkForSelectedCoin(txRow.tx.txid)) {
                        txRow.select()
                        dispatchLater = true
                    }
                    txRow.addEventListener('txRowCustomSelected', (e) => {
                        this.fireCustomSelectedEvent()
                    })
                    
                    txRow.addEventListener('txRowSelected', e=>{
                        let selectedRow = e.target;
                        if (e.detail.selected) {
                            this.selectedRows.push({
                                txid: e.detail.txid,
                                vout: e.detail.vout,
                                amount: e.detail.amount.toFixed(8)
                            });
                        } else {
                            this.selectedRows = this.selectedRows.filter(row => !(row.txid === e.detail.txid && row.vout === e.detail.vout))
                        }
                        if (this.selectedRows.length == 0) {
                            this.selectedRowsActionBox.classList.add('hidden');
                        } else {
                            this.selectedRowsActionBox.classList.remove('hidden');
                        }
                    });
                }
                if (dispatchLater) {
                    this.fireCustomSelectedEvent()
                }
            }
        }
        
        /** 
        * If this event is fired, then some row got ticked/unticked in the custom-selection-column
        */
        fireCustomSelectedEvent() {
            let event = new CustomEvent('CustomSelected', { detail: {
                txs: this.getSelectedTxs()
            } }
            );
            this.dispatchEvent(event);
        }
    }



    /**
     * Shows a <tx-data> element popup for specified txid.
     * @param btcUnit - Bitcoin unit to display amounts with. Either "btc" or "sat"
     * @param price - BTC price for price calculations
     * @param symbol - Currency symbol for price calculations
     * @param txid - ID of the transaction to show.
     * @param wallet - The wallet alias of the wallet the transaction is associated with.
    */
    function showTxData(btcUnit, price, symbol, txid, wallet) {
        if (wallet) {
            let txDataPopup = document.getElementById('tx-popup');
            txDataPopup.innerHTML = `
            <tx-data
            data-btc-unit="${btcUnit ? btcUnit : 'btc'}"
            data-price="${price ? price : 0}"
            data-symbol="${symbol ? symbol : ''}"
            data-txid="${txid}"
            data-tx-wallet="${wallet}">
            </tx-data>`;
            showPageOverlay('tx-popup');
        } else {
            copyText(txid, `{{ _("Copied transaction") }}: ${ txid }`);
        }
    }

    customElements.define('tx-table', TxTableElement);
</script>
