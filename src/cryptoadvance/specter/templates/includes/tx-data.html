{#
    The <template> defines the styling and structure of the web component.
    
    When it is instantiated it is populated with various `data-*` attributes which are
    read in for initial configuration data.

    In the JS constructor additional data is fetched from the server and then populated
    into the <template>.
#}
<template id="tx-data">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .tx-data-table td {
            text-align: left;
        }
        .tx_info {
            padding: 1em;
            border: 1px solid #506072;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 2em;
        }
    </style>
    <div class="tx-data">
        <h2>{{ _("Transaction details") }}</h2><br>
        <table class="tx-data-table">
            <tbody>
                <tr>
                    <td><span class="optional">{{ _("Transaction id") }}:</span><span class="mobile-only">TxID:</span></td>
                    <td style="word-break: break-all;" class="tx-explorer-link"></td>
                </tr>
                <tr><td>{{ _("From wallet:") }}</td><td><a class="tx-wallet-link"></a></td></tr>
                <tr><td>{{ _("Size:") }}</td><td><span class="tx-vbsize"></span> vbytes <span class="note">(<span class="tx-size"></span> bytes)</span></td></tr>
                <tr class="tx-fee-row"><td>{{ _("Fee:") }}</td><td><span class="tx-fee"></span> sats</td></tr>
                <tr class="tx-fee-rate-row"><td>{{ _("Fee rate:") }}</td><td><span class="tx-fee-rate"></span> sat/vbyte</td></tr>
                <tr class="tx-mined-row1"><td>{{ _("Mined at block:") }}</td><td class="tx-blockheight"></td></tr>
                <tr class="tx-mined-row2"><td>{{ _("Block hash:") }}</td><td style="word-break: break-all;" class="tx-blockhash"></td></tr>
                <tr class="tx-mined-row3"><td>{{ _("Block time:") }}</td><td><span class="tx-blocktime"></span> <span style="font-size: 0.9em;color: #ccc;" class="tx-blocktime-epoch"></span></td></tr>
                <tr><td>{{ _("Inputs count:") }}</td><td class="tx-inputs-count"></td></tr>
                <tr><td>{{ _("Outputs count:") }}</td><td class="tx-outputs-count"></td></tr>
            </tbody>
        </table>
        <div class="tx-data-info">
        </div>
        <div class="message"></div>

        <div class="abandon-tx-container hidden">
            <div class="warning">
                <p><b>{{ _( "This transaction (aka \"tx\") could not be found in your node's mempool!") }}</b></p>
                <p style="text-align:left;">{{ _( "If the bitcoin network is very busy, nodes will start purging the pending txs with the lowest fees. Txs older than two weeks are also purged.") }}</p>
                <p style="text-align:left;">{{ _( "A purged tx will never complete. Abandoning this tx will clear it from your wallet, making those funds spendable once again.") }}</p>
                <p style="text-align:left;">{{ _( "But first verify that other nodes have also purged your tx! Enter the tx id into a public block explorer (warning: slight privacy leak). If the tx cannot be found, it is safe to abandon this tx.") }}</p>

                <br/><br/>
                <form method="POST" class="abandon-tx-form">
                    <input type="hidden" class="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="abandon_tx"/>
                    <input type="hidden" name="txid" class="abandon-tx-txid"/>
                    <button type="submit" name="action" value="abandontx" class="btn danger centered" style="max-width: 160px;">{{ _("Abandon transaction") }}</button>
                </form>
            </div>
        </div>

    </div>
</template>
  
<script type="text/javascript">
    class TxDataElement extends HTMLElement {
        constructor() {
            super();
            // Create a shadow root
            var shadow = this.attachShadow({mode: 'open'});
            var style = document.getElementById('tx-data').content;
            var clone = style.cloneNode(true);
            this.el = clone.querySelector(".tx-data");

            this.info = clone.querySelector(".tx-data-info");
            this.message = clone.querySelector(".message");
            this.abandonTxContainer = clone.querySelector(".abandon-tx-container");
            this.abandonTxForm = clone.querySelector(".abandon-tx-form");
            this.abandonTxTxid = clone.querySelector(".abandon-tx-txid");

            this.txExplorerLink = clone.querySelector(".tx-explorer-link");
            this.txWalletLink = clone.querySelector(".tx-wallet-link");
            this.txVbsize = clone.querySelector(".tx-vbsize");
            this.txSize = clone.querySelector(".tx-size");
            this.txFeeRow = clone.querySelector(".tx-fee-row");
            this.txFee = clone.querySelector(".tx-fee");
            this.txFeeRateRow = clone.querySelector(".tx-fee-rate-row");
            this.txFeeRate = clone.querySelector(".tx-fee-rate");
            this.txMinedRow1 = clone.querySelector(".tx-mined-row1");
            this.txMinedRow2 = clone.querySelector(".tx-mined-row2");
            this.txMinedRow3 = clone.querySelector(".tx-mined-row3");
            this.txBlockheight = clone.querySelector(".tx-blockheight");
            this.txBlockhash = clone.querySelector(".tx-blockhash");
            this.txBlocktime = clone.querySelector(".tx-blocktime");
            this.txBlocktimeEpoch = clone.querySelector(".tx-blocktime-epoch");
            this.txInputsCounts = clone.querySelector(".tx-inputs-count");
            this.txOutputsCounts = clone.querySelector(".tx-outputs-count");

            // Copy data from the component's `data-*` attributes
            this.txid = this.getAttribute('data-txid');
            this.wallet = this.getAttribute('data-tx-wallet');
            this.btcUnit = this.getAttribute('data-btc-unit');
            this.price = this.getAttribute('data-price');
            this.symbol = this.getAttribute('data-symbol');

            this.message.innerText = `{{ _("Loading transaction details...\n\nTransaction ID:") }}" ${this.txid}`;
            this.fetchTxData();
        
            // Attach the created element to the shadow dom
            shadow.appendChild(clone);
        }
        
        async fetchRawTx(txid) {
            let url = `{{ url_for('wallets_endpoint.decoderawtx', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
            var formData = new FormData();
            formData.append('txid', txid);
            formData.append('csrf_token', '{{ csrf_token() }}');
            try {
                const response = await fetch(
                    url,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                if(response.status != 200){
                    showError(await response.text());
                    return null;
                }
                const jsonResponse = await response.json();
                return jsonResponse;
            } catch(e) {
                this.message.innerText = '{{ _("Failed to load transaction details...") }}';
                console.log("Caught error fetching decoded transaction: ", e);
                showError(`{{ _("Failed to fetch data. Please refresh the page and retry.") }}`);
            }
            return null;
        }

        async fetchTxData() {
            let jsonResponse = await this.fetchRawTx(this.txid);
            if (jsonResponse !== null && jsonResponse.success) {
                console.log(jsonResponse);
                let rawtx = jsonResponse.rawtx;
                let tx = jsonResponse.tx;
                let walletUrl = `{{ url_for('wallets_endpoint.wallet', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);

                if (tx.is_purged) {
                    this.message.classList.add("hidden");
                    this.abandonTxContainer.classList.remove("hidden");
                    this.abandonTxForm.setAttribute("action", `${walletUrl}history/`);
                    this.abandonTxTxid.value = this.txid;
                }

                this.txExplorerLink.innerHTML = `<explorer-link data-type="tx" data-value="${this.txid}"></explorer-link>`;
                this.txWalletLink.setAttribute("href", walletUrl);
                this.txWalletLink.innerText = jsonResponse.walletName;
                this.txVbsize.innerText = rawtx.vsize;
                this.txSize.innerText = rawtx.size;

                let rawtxHTML = "";
                if (tx.fee) {
                    let fee = tx.fee;
                    if(typeof tx.fee == "object"){
                        if("bitcoin" in tx.fee){
                            fee = tx.fee.bitcoin;
                        }
                    }
                    this.txFee.innerText = parseInt(-1e8 * fee);
                    this.txFeeRate.innerText = parseFloat((-1e8 * fee / rawtx.vsize).toFixed(2)).toString();
                } else {
                    this.txFeeRow.classList.add("hidden");
                    this.txFeeRateRow.classList.add("hidden");
                }

                if (tx.confirmations && tx.confirmations > 0) {
                    this.txBlockheight.innerText = tx.blockheight;
                    this.txBlockhash.innerText = tx.blockhash;
                    this.txBlocktime.innerText = new Date(tx.blocktime * 1000);
                    this.txBlocktimeEpoch.innerText = `(${tx.blocktime})`;
                } else {
                    this.txMinedRow1.classList.add("hidden");
                    this.txMinedRow2.classList.add("hidden");
                    this.txMinedRow3.classList.add("hidden");
                }

                this.txInputsCounts.innerText = rawtx.vin.length;
                this.txOutputsCounts.innerText = rawtx.vout.length;

                rawtxHTML += `<h3>Inputs</h3>`;
                for (let i in rawtx.vin) {
                    let bgColor = '#131a24';
                    let addressAndValue = '';
                    let jsonResponse = await this.fetchRawTx(rawtx.vin[i].txid);
                    if (jsonResponse !== null && jsonResponse.success) {
                        let spentOutput = jsonResponse.rawtx.vout[rawtx.vin[i].vout];
                        let address = (spentOutput.addresses && spentOutput.addresses.length == 1) ? spentOutput.addresses[0] : 'Unknown';
                        if (address == 'Unknown') {
                            address = (spentOutput.scriptPubKey.addresses && spentOutput.scriptPubKey.addresses.length == 1) ? spentOutput.scriptPubKey.addresses[0] : 'Unknown';
                        }
                        if (address == 'Unknown') {
                            address = spentOutput.scriptPubKey.address ? spentOutput.scriptPubKey.address : 'Unknown';
                        }
                        if (address == 'Unknown') {
                            address = spentOutput.address ? spentOutput.address : 'Unknown';
                        }
                        let isMine = await this.fetchAddressIsMine(address);
                        if (isMine) {
                            bgColor = '#925d07';
                        }


                        let value = "Confidential";
                        let price = '';
                        let assetlabel = "";
                        if("assetlabel" in spentOutput){
                            assetlabel = spentOutput.assetlabel;
                        }
                        if (spentOutput.value) {
                            value = parseFloat(spentOutput.value.toFixed(8));
                            if(assetlabel == "LBTC" || assetlabel == ""){
                                if (this.price && this.symbol) {
                                    price = `<span class="note">(${this.symbol}${numberWithCommas((parseFloat(this.price) * value).toFixed(2))})</span>`;
                                }

                                if (this.btcUnit == 'sat') {
                                    assetlabel = "sat";
                                    value = parseInt(value * 1e8);
                                }
                            }
                            value = `${numberWithCommas(value.toString())}`;
                        }

                        addressAndValue = `<br>
                            {{ _("Address:") }} <address-label data-copy-hidden="true" data-address="${address}" data-wallet="${this.wallet}"></address-label><br>
                            {{ _("Value:") }} ${value} ${assetlabel} ${price}`;
                    }

                    if ('coinbase' in rawtx.vin[i]) {
                        rawtxHTML += `
                        <p class="tx_info" style="text-align: left; background-color: ${bgColor};">
                            <b>{{ _("Input #") }}${i}</b><br><br>
                            <b>{{ _("Coinbase transaction") }}</b>
                            <br>
                        </p>
                        `;
                        continue;
                    }
                    rawtxHTML += `
                        <p class="tx_info" style="text-align: left; background-color: ${bgColor};">
                            <b>{{ _("Input #") }}${i}</b><br><br>
                            {{ _("Transaction id") }}: <explorer-link style="word-break: break-all;" data-type="tx" data-value="${rawtx.vin[i].txid}"></explorer-link><br>
                            {{ _("Output #") }}: ${rawtx.vin[i].vout}
                            ${addressAndValue}
                        </p>
                    `;
                }

                rawtxHTML += `<h3>{{ _("Outputs") }}</h3>`;
                for (let i in rawtx.vout) {
                    let address = rawtx.vout[i].addresses && rawtx.vout[i].addresses.length == 1 ? rawtx.vout[i].addresses[0] : 'Unknown';
                    if (address == 'Unknown') {
                        address = rawtx.vout[i].scriptPubKey.addresses && rawtx.vout[i].scriptPubKey.addresses.length == 1 ? rawtx.vout[i].scriptPubKey.addresses[0] : 'Unknown';
                    
                    }
                    if (address == 'Unknown') {
                        address = rawtx.vout[i].scriptPubKey.address ? rawtx.vout[i].scriptPubKey.address : 'Unknown';
                    }
                    if (address == 'Unknown') {
                        address = rawtx.vout[i].address ? rawtx.vout[i].address : 'Unknown';
                    }
                    let value = "Confidential";
                    let price = '';
                    let assetlabel = "";
                    if("assetlabel" in rawtx.vout[i]){
                        assetlabel = rawtx.vout[i].assetlabel;
                    }
                    if (rawtx.vout[i].value) {
                        value = parseFloat(rawtx.vout[i].value.toFixed(8));
                        if(assetlabel == "LBTC" || assetlabel == ""){
                            if (this.price && this.symbol) {
                                price = `<span class="note">(${this.symbol}${numberWithCommas((parseFloat(this.price) * value).toFixed(2))})</span>`;
                            }

                            if (this.btcUnit == 'sat') {
                                assetlabel = "sat";
                                value = parseInt(value * 1e8)
                            }
                        }
                        value = `${numberWithCommas(value.toString())}`;
                    }

                    let bgColor = '#131a24';
                    let isMine = await this.fetchAddressIsMine(address);
                    if (isMine) {
                        bgColor = '#154984';
                    }

                    rawtxHTML += `
                    <p class="tx_info" style="text-align: left; background-color: ${bgColor};">
                        <b>{{ _("Output #${i}") }}</b><br><br>
                        {{ _("Address:") }} <address-label data-copy-hidden="true" data-address="${address}" data-wallet="${this.wallet}"></address-label><br>
                        {{ _("Value:") }} ${value} ${assetlabel} ${price}
                    </p>
                    `;
                }
                
                this.info.innerHTML = rawtxHTML;
                this.message.innerText = "";
                return;
            };
            this.message.innerText = '{{ _("Failed to load transaction details...") }}';
        }
        
        async fetchAddressIsMine(address) {
            let url = `{{ url_for('wallets_endpoint.addressinfo', wallet_alias='WALLET_ALIAS') }}`.replace("WALLET_ALIAS", this.wallet);
            var formData = new FormData();
            formData.append('address', address)
            formData.append('csrf_token', '{{ csrf_token() }}');
            try {
                const response = await fetch(
                    url,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                if(response.status != 200){
                    showError(await response.text());
                    return false;
                }
                const jsonResponse = await response.json();
                if (jsonResponse.success) {
                    return jsonResponse.isMine;
                }
            }  catch(e) {
                showError(`{{ _("Failed to load address data...") }}`);
                showError(e);
            }
            return false;
        }
    }
    customElements.define('tx-data', TxDataElement);
</script>
