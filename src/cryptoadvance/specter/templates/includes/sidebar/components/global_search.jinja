<script>
    var changed_elements = [];
    var timeOutIds = [];

    /**
    Resets the highlighting of previously highlighted elements
    */
    function reset_highlight(){
        console.log('before resetting')
        console.log(changed_elements)
        for (var i in changed_elements){ 
            changed_elements[i].element.style = changed_elements[i].old_style;
        } 
    }


    function endpoint_is_visible(allowed_endpoint){
        return ('{{ url_for(request.endpoint, **request.view_args) }}'.indexOf(allowed_endpoint) >= 0)
    }


    /**
    Fetches an element by the id. 
    If it is below a shadowRoot the argument should be 
        ids = [f"addresses-table-{wallet.alias}","shadowRoot","receive-addresses-view-btn"]
    */
    function element_by_ids(ids){
        if (!ids) {return null};

        if (typeof ids === 'string' || ids instanceof String){        
            ids = [ids];
        }


        var last_found_element = document;
        var found_element = null;
        console.log(ids)
        for (var i in ids){
            if (ids[i] == 'shadowRoot'){
                found_element = last_found_element.shadowRoot;
            }
            else {
                found_element = last_found_element.getElementById(ids[i]);
            }

            if (!found_element) {break}

            last_found_element = found_element;
        }

        if (last_found_element === document){return null};

        return last_found_element
    }

    /**
    It transferred the search_term to another input (such as a input that filters a table)
    */
    function apply_filter_to_input(html_element, search_term){
        if (!html_element.filter_via_input_ids) {return};
    
        var found_element = element_by_ids(html_element.filter_via_input_ids);
        if (!found_element) {return}
        
        console.log(found_element);
        found_element.value = search_term;
        if (found_element.onchange){
            found_element.onchange();
        }
        else {
            console.log('No onchange connected for ',found_element)
        }
    }

    /**
    Applies the new style (like background color) to an html_element
    */
    function apply_new_style(found_element){
        console.log(`setting green ${found_element.id}`);

        // add the found_element to changed_elements  if it is not in there already
        element_already_exists = false;
        for (var i in changed_elements){
            if (changed_elements[i].element == found_element){
                element_already_exists = true;
            }
        }
        if (!element_already_exists){
            changed_elements.push({element:found_element, old_style:found_element.style});
        }
        found_element.style.backgroundColor = 'var(--cmap-blue-darker)';    
    }

    /**
    Takes a HtmlElement.json()  and does all necessary operations
    */
    function process_html_element(html_element, search_term){
        if (!endpoint_is_visible(html_element.visible_on_endpoints)){return};
        apply_filter_to_input(html_element, search_term);

        if (html_element.result == null){return};
        if (html_element.result <= 0){return};

        var found_element = element_by_ids(html_element.id); 
        if (!found_element) {return};
        apply_new_style(found_element);
    }

    

    /**
    Sends the search_term to an endpoint, gets the answer back and then calls process_html_element
    */    
    function global_search(search_term){
        reset_highlight();
        var formData = new FormData();
        formData.append('global_search_input', document.getElementById('global_search_input').value);

        let url="{{ url_for('wallets_endpoint_api.global_search' ) }}";
        send_request(url, 'POST', "{{ csrf_token() }}", formData).then((answer)=> {
            if (!answer){return}
            //console.log(answer)
            
            for (var i in answer.list){
                var html_element = answer.list[i];
                process_html_element(html_element, answer.search_term) ;
            }
            

        });
    }


    /**
    This function starts global_search with a delay

    If a new delayed_global_search is called, it will stop all old Timeouts.

    This ensures only the newest search is actually performed.
    */
    function delayed_global_search(search_term){
        // stop old processes
        for (var i = timeOutIds.length; i >= 0; i--) {
            clearTimeout(timeOutIds[i]);      
            console.log(`Stopped ${timeOutIds[i]}`)
            timeOutIds.splice(i, 1);
        }
        
        const timeOutId = setTimeout(() => global_search(search_term), 100);
        timeOutIds.push(timeOutId);
    }


</script>

<input  id="global_search_input" title="Search for addresses, transactions, amounts, ... and click on the highlighted buttons."  
        placeholder="Search..." oninput="delayed_global_search(this.value)"/>

