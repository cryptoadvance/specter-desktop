<template id="global-search">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">

    <style type="text/css">
        .global-search-row {
            background-color: var(--cmap-bg-lighter);
            padding-left:10px;
            padding-right:2px;
            padding-top:2px;
            padding-bottom:2px;
            margin-bottom:2px;
            word-wrap: break-word;
        }
        .global-search-row:hover {
            background-color: var(--cmap-border);
        }


        .global-search-dropdown {
            --cmap-found_term: #306d30;    
            margin: 20px 20px 5px;
        }

        .global-search-dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--cmap-bg);
            width: 90%;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,1);
            padding: 5px 5px;
            z-index: 1;
            overflow-y:scroll;
            max-height: 50%;
        }

        
    </style>

    <div class="global-search-dropdown">
        <input  id="global-search-input" title="Search for addresses, transactions, amounts, ..."  
                placeholder="Search..."/>
        <div class="global-search-dropdown-content" id="global-search-dropdown-content">
        </div>
    </div>
</template>


<script type="text/javascript">
	class GlobalSearch extends HTMLElement {
		constructor() {
			super();

			this.internals = this.attachInternals();

            this.timeOutIds = [];

            this.last_answer = null; // be overwritten with the first search call
            this.last_max_number_of_main_results = 5; // the number will be overwritten with the first search call
            this.last_max_number_of_sub_results = 5; // the number will be overwritten with the first search call

			this.buildHTML();			// created the html
			this.attachListeners();		// attaches the listeners to some html objects
    }




		// creates the entire html code (without event listeners)  from the template
		buildHTML(){
			// Create a shadow root
			this.attachShadow({
				mode: 'open'
			});

			var template_content = document.getElementById('global-search').content;
            let clone = template_content.cloneNode(true);

            this.searchInputElement = clone.getElementById('global-search-input');
            this.dropdownContentElement = clone.getElementById('global-search-dropdown-content');

            this.shadowRoot.appendChild(clone);
		}



		// adds EventListeners 
		attachListeners(){
			this.searchInputElement.addEventListener('input', event=>{
				this.delayedGlobalSearch(this.searchInputElement.value);
			});			
        }



        uiElementToLink(ui_element){
            var a = document.createElement("a");
            a.style = "color: #fff;"                
            a.href = ui_element.endpoint ? ui_element.endpoint.url : "";
            a.text = ui_element.title;
            return a
        }


        callEndpoint(endpoint, backup_href){
            if (endpoint){
                if (endpoint.method_str == 'href'){
                    location.href = endpoint.url;
                } else if (endpoint.method_str == 'form')  {
                    submitForm(endpoint.url, "{{ csrf_token() }}", endpoint.form_data);
                }
            } else {
                location.href = backup_href;    
            }                    
        }


        /**
        Takes a result_dict and adds it to the result list
        */
        addResultToResultDropbdown(result_dict, searchTerm, max_number_of_sub_results=5){
            if (result_dict.search_hits == []){return};

            // create parent navigation header            
            var div = document.createElement("div");
            div.className = "global-search-row";

            // add all parents 
            for (var i in result_dict.ui_element.flattened_parent_list){
                var parent = result_dict.ui_element.flattened_parent_list[i];
                // skip the html root
                if (parent.flattened_parent_list.length == 0){continue}

                div.appendChild(this.uiElementToLink(parent));
                div.innerHTML +=  '&nbsp;&nbsp;>&nbsp;&nbsp;';
            }
            var lastParent = this.uiElementToLink(result_dict.ui_element);
            div.addEventListener('click', event=>{
                location.href = lastParent.href;
            });			
            div.style.cursor = "pointer";
            div.appendChild(lastParent);
            this.dropdownContentElement.appendChild(div);
        

            // show search results
            for (var i in result_dict.search_hits){
                var div_result = document.createElement("div");
                div_result.className = "global-search-row";
                
                div_result.style.fontSize = "small";

                if (i>max_number_of_sub_results){
                    div_result.innerHTML += `+ ${result_dict.search_hits.length - max_number_of_sub_results} more results in this category`
                    div_result.addEventListener('click', event => {
                        this.buildDropdownContent(
                            searchTerm, 
                            this.last_answer,
                            this.last_max_number_of_main_results, 
                            5+max_number_of_sub_results
                        );
                    });
                    this.dropdownContentElement.appendChild(div_result);
                    break
                }
                // it is critical that this is a const, overwise the addEventListener('click') will not referr to the current, but to the last result in the loop
                const result = result_dict.search_hits[i];

                // if a title is available for the search result display it nicer
                if (result.title  && result.key){
                    div_result.innerHTML += `${result.title}&nbsp;&nbsp;>&nbsp;&nbsp;${result.key}: `;
                } 
                div_result.innerHTML += this.highlightString(`${result.value}`, searchTerm);


                div_result.addEventListener('click', event => {
                    this.callEndpoint(result.endpoint, lastParent.href) 
                });			
                div_result.style.cursor = "pointer";
                this.dropdownContentElement.appendChild(div_result);
            }
        }

        highlightString(fullText, searchTerm){             
            var regex = new RegExp(searchTerm, "gi");  
            return fullText.replace(regex, "<span style='background-color: var(--cmap-found_term);'>$&</span>");
        }


        addResultsHeader(results, searchTerm){
            if (results.length == 0){
                var div = document.createElement("div");
                div.className = "global-search-row";
                div.innerText = `No results found.`;
                this.dropdownContentElement.appendChild(div);
            } else {
                // show nothing
                // var div = document.createElement("div");
                // div.className = "global-search-row";
                // div.innerText = `${results.length} results:`;
                // this.dropdownContentElement.appendChild(div);
            }
        }

                
        clearDropdownContent(){
            while (this.dropdownContentElement.firstChild) {
                this.dropdownContentElement.removeChild(this.dropdownContentElement.firstChild);
            } 
        }


        setContentVisibility(visible){
            this.dropdownContentElement.style.display = visible ? "block" : "none";   
        }


        buildDropdownContent(searchTerm, answer, max_number_of_main_results=5, max_number_of_sub_results=5){
            this.last_max_number_of_main_results = max_number_of_main_results;
            this.last_max_number_of_sub_results = max_number_of_sub_results;
            this.clearDropdownContent();
            this.addResultsHeader(answer.result_dicts);

            for (var i in answer.result_dicts){
                // if there are too many results, add a div showing missing elements
                if (i>max_number_of_main_results){
                    var div = document.createElement("div");
                    div.className = "global-search-row";
                    div.innerText += `+ ${answer.result_dicts.length - max_number_of_main_results} more results`;
                    div.addEventListener('click', event => {
                        this.buildDropdownContent(
                            searchTerm, 
                            answer,
                            5+max_number_of_main_results, 
                            max_number_of_sub_results
                        );
                    });			
                    this.dropdownContentElement.appendChild(div);
                    break;
                }
                this.addResultToResultDropbdown(
                    answer.result_dicts[i], 
                    answer.search_term, 
                    max_number_of_sub_results
                );                    
            }

            this.setContentVisibility(answer.result_dicts.length > 0);
        }


        /**
        Sends the searchTerm to an endpoint, gets the answer back and then calls addResultToResultDropbdown
        */    
        globalSearch(searchTerm, max_number_of_main_results=100, max_number_of_sub_results=5){
            var formData = new FormData();
            formData.append('global-search-input', this.searchInputElement.value);

            let url="{{ url_for('wallets_endpoint_api.global_search' ) }}";
            send_request(url, 'POST', "{{ csrf_token() }}", formData).then((answer)=> {
                // this is to account for the fact that the input element can have changed during the request
                // if the user quickly deletes the search term again, there should be no search window appearing
                if ((this.searchInputElement.value == "") ||  (!answer)) {
                    this.setContentVisibility(false);
                    return
                }                
                this.last_answer = answer;
                //console.log(answer)

                this.buildDropdownContent(
                    searchTerm, 
                    answer, 
                    max_number_of_main_results, 
                    max_number_of_sub_results
                )
            });
        }





        /**
        This function starts global_search with a delay

        If a new delayedGlobalSearch is called, it will stop all old Timeouts.

        This ensures only the newest search is actually performed.
        */
        delayedGlobalSearch(searchTerm){        
            // stop old processes
            for (var i = this.timeOutIds.length; i >= 0; i--) {
                clearTimeout(this.timeOutIds[i]);      
                //console.log(`Stopped ${this.timeOutIds[i]}`)
                this.timeOutIds.splice(i, 1);
            }

            const timeOutId = setTimeout(() => this.globalSearch(searchTerm), 100);
            this.timeOutIds.push(timeOutId);
        }





	}
	customElements.define('global-search', GlobalSearch);
</script>