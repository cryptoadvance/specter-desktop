<template id="asset-label">
    <style>
        .asset-label-form {
            display: inline;
        }
        .label {
            word-break: break-all;
            background: none;
            color: #fff;
            font-size: 1em;
            max-width: 80%;
            outline: none;
        }

        .edit {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            width: 18px;
            cursor: pointer;
        }
        .cancel, .update {
            background: var(--cmap-border);
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 8px 15px 8px 10px;
            color: #fff;
            font-size: 0.75em;
            text-align: center;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 33px;
            margin-left: 5px;
        }

        .hidden {
            display: none;
        }

        .svg-white {
            filter: invert(100%) sepia(0%) saturate(1%) hue-rotate(304deg) brightness(102%) contrast(101%);
        }
    </style>
    <form class="asset-label-form">
        <input type="hidden" class="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>
        <span class="label" autocomplete="off" spellcheck="false">Fetching asset label...</span>
        <button type="button" class="btn edit" title="Edit label"><img src="{{ url_for('static', filename='img/edit.svg') }}" style="width: 22px; margin-bottom:-5px;" class="svg-white"/></button>
        <button type="button" class="btn update hidden">Update</button>
        <button type="button" class="btn cancel hidden">Cancel</button>
    </form>
</template>

<script type="text/javascript">
    class AssetLabelElement extends HTMLElement {
        constructor() {
            super();
            // Create a shadow root
            var shadow = this.attachShadow({mode: 'open'});
            var style = document.getElementById('asset-label').content;
            var clone = style.cloneNode(true);
            this.el = clone.querySelector(".asset-label-form");
            this.label = clone.querySelector(".label");
            this.update = clone.querySelector(".update");
            this.cancel = clone.querySelector(".cancel");
            this.edit = clone.querySelector(".edit");
        
            // Attach the created element to the shadow dom
            shadow.appendChild(clone);
        }

        connectedCallback() {
            this.asset = this.getAttribute('data-asset');
            this.labelValue = this.getAttribute('data-label');
            this.label.title = this.asset;
            this.isEditing = false;

            // Set the label - fetch if not specified
            if (this.labelValue) {
                this.label.innerText = this.labelValue;
            } else {
                this.label.innerText = this.asset;
                // fetchAssetLabel(this);
            }

            // Set title mode for asset-label element
            if (this.getAttribute('date-size') == 'title') {
                this.isTitle = true;
                this.label.style.fontSize = '1.5em';
                this.el.style.fontSize = '1.2em';
                this.edit.style.width = '30px';
                this.edit.children[0].style.width = '30px';
            } else {
                this.isTitle = false;
            }

            // Ensure text pasted is not formatted with special formatting.
            this.label.addEventListener('paste', function (event) {
                event.preventDefault();
                document.execCommand('inserttext', false, event.clipboardData.getData('text/plain'));
            });

            this.edit.onclick = () => {
                this.label.setAttributeNode(document.createAttribute('contenteditable'));
                if (this.isTitle) {
                    this.label.style['font-size'] = '1.1em';
                }
                this.label.style['border-bottom'] = '1px solid #ccc';
                this.labelValue = this.label.innerText;
                this.edit.classList.add('hidden');
                this.cancel.classList.remove('hidden');
                this.update.classList.remove('hidden');
                this.isEditing = true;
            }

            this.cancel.onclick = () => {
                this.label.innerText = this.labelValue;
                this.closeEditMode();
            }

            this.update.onclick = async () => {
                if (await this.setAssetLabel()) {
                    this.labelValue = this.label.innerText;
                    this.closeEditMode(this);
                    let event = new CustomEvent('updateAssetLabel', { detail: {
                        label: this.labelValue,
                        asset: this.asset,
                    }});
                    document.dispatchEvent(event);
                    if (!this.labelValue) {
                        this.label.innerText = this.asset
                    }
                } else {
                    showError('Failed to update asset label. Please refresh the page and try again.')
                }
            }
        
            this.addEventListener("updateAssetLabel", function (e) {
                if (this.asset != e.detail.asset) {
                    return
                }
                this.labelValue = e.detail.label
                if (!this.isEditing) {
                    if (e.detail.label) {
                        this.label.innerText = e.detail.label
                    } else {
                        this.label.innerText = e.detail.asset
                    }
                }
            });
        }
        closeEditMode() {
            this.label.removeAttribute('contenteditable')
            if (this.isTitle) {
                this.label.style['font-size'] = '1.5em';
            }
            this.label.style.border = 'none';
            this.edit.classList.remove('hidden');
            this.cancel.classList.add('hidden');
            this.update.classList.add('hidden');
            this.isEditing = false;
        }

        async setAssetLabel() {
            let url = `{{ url_for('settings_endpoint.set_asset_label') }}`;
            var formData = new FormData();
            formData.append('asset', this.asset);
            formData.append('label', this.label.innerText);
            formData.append('csrf_token', '{{ csrf_token() }}');
            try {
                const response = await fetch(
                    url,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                if(response.status != 200){
                    showError(await response.text());
                    return;
                }
                const jsonResponse = await response.json();
                return jsonResponse.success;
            } catch(e) {
                console.log("Caught error: ", e);
                showError(e);
                return false;
            }
        }
    }

    customElements.define('asset-label', AssetLabelElement);
</script>
