{% extends "base.jinja" %}
{% block main %}

{% include "includes/hwi.jinja" %}

<h1>{{wallet.name}}</h1>
{% from 'includes/components/wallet_menu.jinja' import wallet_menu %}
{{ wallet_menu("wallet_receive", wallet_alias) }}
<div class="center">
<form action="./" method="POST">
	{% set addrlabel = wallet.getaddressname(wallet['address'], wallet['address_index']) %}
	<input type="text" autocomplete="off" spellcheck="false" id="label" name="label" value="{{addrlabel}}" style="text-align: center; border: none; font-size: 1.5em;" disabled>
	<button type="submit" id="save" name="action" value="updatelabel" class="btn centered" style="display: none;">Update</button>
	<button type="button" id="cancel" onclick="toggleEdit()" class="btn centered" style="display: none;">Cancel</button>
	<button type="button" id="edit" onclick="toggleEdit()" name="action" value="updatelabel" class="btn centered">Edit Label</button>
</form><br><br>

<script src="/static/qr/vue-qrcode.min.js"></script>
<div id="qrdiv" class="alt-qr">
	<qrcode value="{{'bitcoin:'+wallet['address']+'?index='+(wallet['address_index']|string) }}" :options="{ width: 300 }" tag="img"></qrcode>
</div>
<script>
	Vue.component(VueQrcode.name, VueQrcode);
	new Vue({el: "#qrdiv"})
</script>

<br>
<small>( scan to verify )</small>
<div class="padded">{{wallet['address']}}</div>
</div>
<form action="./" method="POST">
	<button type="submit" name="action" value="newaddress" class="btn centered">Get new address</button>&nbsp;
	{% if wallet['type'] == 'simple' %}
		<button type="button" onclick="displayAddressOnDevice()" class="btn centered">Display Address on Device</button>&nbsp; &nbsp; &nbsp;
	{% endif %}
</form>

<div class="note"><center>Specter can verify this address if you scan it.<br>
It has an address index included in the QR code.</center></div>

<script>
	function displayAddressOnDevice() {
		beginDetectWallet("{{ wallet['device_type'] }}");
		document.getElementById("hwi_unlocked__submit").addEventListener("click", async function(e) {
			e.preventDefault();
			document.getElementById("hwi_device_name").textContent = '{{wallet["device_type"]|capitalize}}';
			showPageOverlay(HWI_POPUPS.DISPLAY_ADDRESS);

			var formData = new FormData();
			formData.append("type", hwiCurrentWallet.type);
			formData.append("path", hwiCurrentWallet.path);
			formData.append("passphrase", hwiWalletPassphrase);
			formData.append("descriptor", "{{ wallet['recv_descriptor'].replace('*', wallet['address_index']|string).split('#')[0] }}");

			const response = await fetch(
				'/hwi/display_address/',
				{
					method: 'POST',
					body: formData
				}
			);
			const jsonResponse = await response.json();
			if (jsonResponse.success) {
				console.log(jsonResponse)
				if ("{{ wallet['address'] }}" != jsonResponse.status.address &&
					(("{{ specter.chain }}" != "regtest" || !jsonResponse.status.address.startsWith("tb")) ||
					"{{ wallet['address'] }}".slice(0, -6) != "bcrt" + jsonResponse.status.address.slice(2, -6))
				) {
					alert("Addresses did not match! Be careful! Please contact support and beware of using the displayed address!");
				}
			} else {
				alert(jsonResponse.error);
			}

			hidePageOverlay();
		});
	}

	function toggleEdit() {
		var edit_button_display = document.getElementById("edit").style.display
		if (edit_button_display === 'none'){
			document.getElementById("label").disabled = 'true'
			document.getElementById("label").style.border = 'none'
			document.getElementById("label").style.fontSize = '1.5em';
			document.getElementById("label").value = "{{ addrlabel }}"
			document.getElementById("edit").style.display = 'block'
			document.getElementById("cancel").style.display = 'none'
			document.getElementById("save").style.display = 'none'
		} else{
			document.getElementById("label").disabled = ''
			document.getElementById("label").style.removeProperty('border');
			document.getElementById("label").style.removeProperty('font-size');
			document.getElementById("edit").style.display = 'none'
			document.getElementById("cancel").style.display = 'block'
			document.getElementById("save").style.display = 'block'
		}
	}
</script>
{% endblock %}
